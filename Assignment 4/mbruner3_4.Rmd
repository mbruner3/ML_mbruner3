---
title: "mbruner3_4"
author: "Mark Bruner"
date: "10/16/2020"
output:
  html_document: default
  pdf_document: default
---

```{r echo = FALSE}
rm(list=ls())
```

```{r}
library(tidyverse)
library(caret)
library(corrplot)
library(factoextra)
library(moments)
library(gridExtra)
set.seed(15)
```
# Part 1: Preparing & Getting to Know Our Data
```{r}
univ <- read_csv("/Users/markbruner/Google Drive/MSBA/Machine Learning/mbruner3/ML_mbruner3/Assignment 4/Universities.csv")
str(univ)
```

```{r}
head(univ)
```

```{r}
tail(univ)
```

```{r}
univ %>% 
  rename(
         college_name  = `College Name`, 
         state = State,
         public1_private2 =`Public (1)/ Private (2)`, 
         appli_recd = "# appli. rec'd", 
         appli_accepted = `# appl. accepted`,
         new_stud = "# new stud. enrolled",
         new_stud_10 = "% new stud. from top 10%",
         new_stud_25 = "% new stud. from top 25%",
         ft_undergrad = "# FT undergrad",
         pt_undergrad = "# PT undergrad",
         in_state = "in-state tuition",
         out_state = `out-of-state tuition`,
         add_fees = `add. fees`,
         book_costs = `estim. book costs`,
         personal_costs = `estim. personal $`,
         perc_PHD = `% fac. w/PHD`,
         stud_fac_ratio = `stud./fac. ratio`,
         grad_rate = `Graduation rate`
  ) -> univ
```

**Applications accepted, received, enrolled, PT/FT undergrads are all counts of students so they can safely be converted into integer values. Public/Private column would be better at a factor than remaining as a character type.**

### Changing Variable Type
```{r}
univ[, c(4:6, 9, 10)] <- sapply(univ[, c(4:6, 9, 10)], as.integer) 

univ$public1_private2 <- as.factor(univ$public1_private2)

str(univ)
```

### Acceptance Rate
```{r}
univ %>%
  mutate(accept_rate =  appli_accepted/appli_recd*100) %>% 
  relocate(college_name, state, public1_private2, appli_accepted, accept_rate, appli_recd, new_stud) -> univ

```

### Separating Continuous & Categorical Variables
```{r}
univ_continuous <- as.data.frame(univ[, c(4:21)])
```
I created this variable "acceptance rate" because it shows if a university is more selective than others where as applications received and accepted doesn't easily show us how "selective" a university is. I kept the applications received column so we could easily get the accepted column back if needed. 

### Exploratory Data Analysis
**UNIVARIATE EXPLORATION**
Summary Statistics
```{r}
summary(univ_continuous) 
```
The range is large for applications received, enrolled new students, and pt/ft students. Percent of faculty with a PHD has a max of 105%.

```{r}
univ_rm_outlier <- univ_continuous # created a separate df for the removed outliers to compare kmeans with and without them.
```

```{r}
ggplot(data = univ_continuous) +
  geom_boxplot(mapping = aes(x = appli_recd)) +
  xlab("Applications Received") 
```
Going to remove the outlier above 40000 applications and will see if it makes a difference in our clustering algorithm or not. 

```{r}
univ_rm_outlier %>% 
  filter(appli_recd > 40000) %>% 
  select(appli_recd)

univ_rm_outlier$appli_recd <- replace(univ_rm_outlier$appli_recd, univ_rm_outlier$appli_recd == 48094, NA)
```


```{r}
ggplot(data = univ_continuous) +
  geom_boxplot(mapping = aes(x = new_stud)) +
  xlab("New Enrolled Students") 
```
```{r}
ggplot(data = univ_continuous) +
  geom_boxplot(mapping = aes(x = ft_undergrad)) +
  xlab("Full-Time Undergraduates") 
```

I won't remove any of the outliers in PT/FT undergrads here because of the number of universities I would have to remove and I think they could be larger state schools. The information, I believe, will be important for the clustering algorithm. 

```{r}
ggplot(data = univ_continuous) +
  geom_boxplot(mapping = aes(x = pt_undergrad)) +
  xlab("Part-Time Undergraduates") 
```

Going to remove the outlier above 20000 applications and will see if it makes a difference in our clustering algorithm or not. 

```{r}
univ_rm_outlier %>% 
  filter(pt_undergrad > 20000) %>% 
  select(pt_undergrad)

univ_rm_outlier$pt_undergrad <- replace(univ_rm_outlier$pt_undergrad, univ_rm_outlier$pt_undergrad == 21836, NA)
```


```{r}
univ_rm_outlier %>% 
  filter(perc_PHD > 100) %>% 
  select(perc_PHD)

univ_rm_outlier$perc_PHD <- replace(univ_rm_outlier$perc_PHD, univ_rm_outlier$perc_PHD > 100, NA)
```

Removed two universities PHD faculty values as they seemed to be reporting mistakes. 

# Part 2: K-means Clustering

### Normalize Continuous Dataset
```{r}
univ_complete_cont <- univ_continuous[complete.cases(univ), ] 
univ_complete_orig <- univ[complete.cases(univ), ] # Keeping the original data seperate to combine clustering results with unnormalized data.


norm <- preProcess(univ_continuous, method = c("scale", "center"))
univ_complete_cont <- predict(norm, univ_complete_cont)

univ_complete_outlier <- univ_rm_outlier[complete.cases(univ), ]
univ_cont_outlier <- predict(norm, univ_complete_outlier)
```


```{r}
# complete.cases function did not remove all the NA's so I am filtering those out of the outlier_complete df. 
univ_cont_outlier %>% 
  filter(!is.na(perc_PHD)) -> univ_cont_outlier

univ_cont_outlier %>% 
  filter(!is.na(appli_recd)) -> univ_cont_outlier

univ_cont_outlier %>% 
  filter(!is.na(pt_undergrad)) -> univ_cont_outlier

colMeans(is.na(univ_complete_cont))
colMeans(is.na(univ_cont_outlier))
```


```{r}
fviz_nbclust(univ_complete_cont, kmeans, method = "wss")
```

```{r}
fviz_nbclust(univ_cont_outlier, kmeans, method = "wss")
```

```{r}
fviz_nbclust(univ_complete_cont, kmeans, method = "silhouette")
```

```{r}
fviz_nbclust(univ_cont_outlier, kmeans, method = "silhouette")
```

**3 clusters would seem to me to be reasonable since you have smaller private and state schools, larger state schools, and ivy league schools. Optimal k would be 3 due to the "elbow" of the curve being at that point.**

### K-means for k = 3 Analysis

```{r}
univ_3kmeans <- kmeans(univ_complete_cont, centers = 3, nstart = 25)
univ_3kmeans_out <- kmeans(univ_cont_outlier, centers = 3, nstart = 25)

```

```{r}
fviz_cluster(univ_3kmeans, data = univ_complete_cont)
```
```{r}
fviz_cluster(univ_3kmeans_out, data = univ_cont_outlier)
```
Based on the clustering above, keeping the outliers in the dataset seems to be better. There is more overlapping in the clusters without the outliers. 

### Combine Cluster labels to the unnormalized dataset.
Doing this to help include observations of the categorical variables and to also see trends in the clusters better. 
```{r}
univ_complete_orig <- cbind(univ_complete_orig, cluster = univ_3kmeans$cluster)
```

### Cluster centers
Creating a df for the centers and will use later for Tufts University.
```{r}
univ_centers <- data.frame(univ_3kmeans$centers)
univ_centers
```
### Cluster Labels to Normalize Dataset
```{r}
univ_complete_cont <- cbind(univ_complete_cont, cluster = univ_3kmeans$cluster)
```

### Comparing Clusters Graphically (attributes columns 1:5)
```{r}
univ_complete_orig %>%  
  group_by(cluster) %>%
  summarise(across(5:21, mean)) -> univ_key

univ_key$cluster <- as.factor(univ_key$cluster)
 
univ_key %>% 
  relocate(cluster, stud_fac_ratio, accept_rate, new_stud_10, new_stud_25, perc_PHD, grad_rate) -> univ_key

univ_key1 <- univ_key[, c(1:7)]
univ_key2 <- univ_key[, c(1, 8:11)]
univ_key3 <- univ_key[, c(1, 12:13)]
univ_key4 <- univ_key[, c(1, 14:18)]

univ_key1 %>% 
  gather(key = "key", value = "value", -cluster) -> univ_key1
univ_key2 %>% 
  gather(key = "key", value = "value", -cluster) -> univ_key2
univ_key3 %>% 
  gather(key = "key", value = "value", -cluster) -> univ_key3
univ_key4 %>% 
  gather(key = "key", value = "value", -cluster) -> univ_key4

library(esquisse)

ggplot(univ_key1) +
 aes(x = key, fill = cluster, weight = value) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "Pastel1") +
 labs(x = "Attributes", y = "Values", title = "University Percentages") +
 theme_minimal() +
 theme(legend.position = "bottom") -> p1

ggplot(univ_key2) +
 aes(x = key, fill = cluster, weight = value) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "Pastel1") +
 labs(x = "Attributes", y = "Values", title = "University Percentages") +
 theme_minimal() +
 theme(legend.position = "bottom") -> p2

ggplot(univ_key3) +
 aes(x = key, fill = cluster, weight = value) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "Pastel1") +
 labs(x = "Attributes", y = "Values", title = "University Percentages") +
 theme_minimal() +
 theme(legend.position = "bottom") -> p3

ggplot(univ_key4) +
 aes(x = key, fill = cluster, weight = value) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "Pastel1") +
 labs(x = "Attributes", y = "Values", title = "University Percentages") +
 theme_minimal() +
 theme(legend.position = "bottom") -> p4

grid.arrange(p1, p2)
```

```{r}
grid.arrange(p3, p4)
```
**Cluster 1:** The universities in cluster 1 have a higher student/faculty ratio than cluster 1, lowest percent of faculty with PHD, has a lower percentage of new students from the top 10/25% of their class, lowest graduation rate but high acceptance rate, have the lowest part-time/full-time undergraduates & new students. Also, they receive the lowest amount of applications from students. Tuition is about the same for students in-state as out-of-state.  

**Cluster 2:** The universities in cluster 2 have the lowest student/faculty, a high percent of faculty with PhD's, highest percent of students from the top 10/25% of their graduating class. Cluster 2 schools are more selective having the lowest acceptance rate. Due to their selectiveness they have lower amount of new students enrolled and those students are mostly full-time. Tuition is the highest of the three clusters and in-state tuition is the same as out-of-state. Room and board are also the highest of the three clusters. 

**Cluster 3:** The universities in cluster 3 have the highest student/faculty ratio, the most applications received, the most accepted new students, have a lower acceptance rate than cluster 1 but higher than cluster 2. Their graduation rate is better than cluster 1 but not as good as cluster 2. They attract more students from the top 10/25% than cluster 1. Tuition is much less for those students in the state of that university but much higher if you are not. 


```{r}

west <- c("AK", "HI", "CA", "OR", "WA", "AZ", "NV", "ID", "MT", "WY", "CO", "NM", "UT")
midwest <- c("SD", "ND", "NE", "KS", "MO", "IL", "IA", "WI", "MN", "OH", "MI", "IN")
south <- c("TX", "OK", "AR", "LA", "MS", "AL", "TN", "GA", "FL", "SC", "NC", "WV", "VA", "KY", "MD", "DE", "DC")
northeast <- c("PA", "NY", "NJ", "CT", "RI", "MA", "NH", "VT", "ME")

region.list <- list(
  Northeast = northeast,
  Midwest= midwest,
  South = south,
  West= west)

univ_complete_orig$regions <- sapply(univ_complete_orig$state, 
                 function(x) names(region.list)[grep(x,region.list)])

univ_complete_orig$cluster <- as.factor(univ_complete_orig$cluster)
univ_complete_orig %>% 
  relocate(college_name, state, regions) -> univ_complete_orig



univ_complete_orig$regions <- as.character(univ_complete_orig$regions)
univ_complete_orig$regions <- as.factor(univ_complete_orig$regions)

ggplot(univ_complete_orig) +
 aes(x = regions, fill = public1_private2) +
 geom_bar(position = "dodge") +
 scale_fill_brewer(palette = "Accent") +
 labs(title = "Universities by Region (by Cluster)") +
 theme_minimal() +
 facet_grid(vars(cluster), vars()) +
 theme(legend.position = "bottom") 
```
```{r}
ggplot(univ_complete_orig) +
 aes(x = ft_undergrad, fill = public1_private2) +
 geom_histogram(bins = 20) +
 scale_fill_brewer(palette = "Accent") +
 labs(title = "Universities by Size (FT Students)") + 
 theme_minimal() +
 facet_grid(vars(cluster), vars(), scales = "free") +
 theme(legend.position = "bottom") 
```

**SUMMARY**
Cluster 1 is a mixture of small private and public schools spread across the country.

Cluster 2 are Ivy league universities mostly located mostly in the Northeast & Midwest regions.

Cluster 3 are mostly large state schools spread all over mainly in the South, Midwest, Norteast regions. 


### Possible Additional External Information
Other external information that could help to explain these clusters could be financial aid awarded, scholarships awarded, GPA, ethnicity, & socieoeconomic status.

# Part 3: Tufts University

**1. Separate Tufts information into df.**
```{r}
univ %>% 
  filter(college_name == "Tufts University") -> tufts
tufts
```

**2. Normalize Tufts df using the preProcess univ_continuous df normalization.**
```{r}
tufts_original <- tufts
tufts_norm <- predict(norm, tufts)
tufts_norm
```

### Tufts Distance from Cluster Centers
```{r}
tufts_dist <- rbind(univ_centers, tufts_norm[, 4:21])
get_dist(tufts_dist, method = "euclidean")
```
Tufts is closest to cluster 2, at a distance of 2.73. Tufts University should be included in cluster 2.

```{r}
univ_complete_orig %>% 
  filter(cluster == 2) %>% 
  summarise(mean(pt_undergrad)) -> mean
```
This is the value that should be imputed into the PT undergrad column in the Tufts University df. 

### Imputing Missing Value
```{r}
univ_complete_orig%>% 
  filter(cluster == 2) -> c2 # created a new df with only cluster 2 so I could find the mean of the pt_undergrad column and impute that value into the missing data in the Tufts df. 

tufts$pt_undergrad <- as.double(tufts$pt_undergrad)
tufts[is.na(tufts$pt_undergrad), "pt_undergrad"] <- mean
tufts_demo <- rbind(tufts_original, tufts)
tufts_demo %>% 
  select(pt_undergrad)
# showing Tufts information before imputing the value and after imputing the value to show that nothing else changed in the columns except for the value missing in pt_undergrad column.
```